<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detección Facial Profesional</title>
  <style>
    body {
      margin: 0;
      background: #0d1117;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
      color: #fff;
    }
    .stage {
      position: relative;
      width: 95vw;
      height: 95vh;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }
    video, canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* efecto espejo */
    }
    #status {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: .5rem 1rem;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <div class="stage">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="status">Cargando modelos…</div>
  </div>

  <script>
    class DeteccionFacial {
      constructor() {
        this.video = document.getElementById('video');
        this.overlay = document.getElementById('overlay');
        this.ctx = this.overlay.getContext('2d');
        this.status = document.getElementById('status');
        this.models = 'https://justadudewhohacks.github.io/face-api.js/models';
        this.isActive = false;
        this.animationFrame = null;
        this.initialize();
      }

      async initialize() {
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(this.models),
          faceapi.nets.faceLandmark68Net.loadFromUri(this.models)
        ]);
        this.status.textContent = 'Modelos cargados';
        this.startCamera();
      }

      async startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
          });
          this.video.srcObject = stream;
          await this.video.play();
          this.resizeOverlay();
          this.isActive = true;
          this.detectFaces();
          this.status.textContent = 'Cámara activa';
        } catch (err) {
          this.status.textContent = 'Error accediendo a la cámara';
        }
      }

      resizeOverlay() {
        this.overlay.width = this.video.videoWidth;
        this.overlay.height = this.video.videoHeight;
      }

      async detectFaces() {
        const detect = async () => {
          if (!this.isActive) return;
          const detections = await faceapi.detectAllFaces(
            this.video,
            new faceapi.TinyFaceDetectorOptions({ inputSize: 256, scoreThreshold: 0.5 })
          ).withFaceLandmarks();

          this.ctx.clearRect(0, 0, this.overlay.width, this.overlay.height);

          if (detections.length > 0) {
            const landmarks = detections[0].landmarks;
            this.drawSmoothMask(landmarks);
            this.status.textContent = 'Rostro detectado';
          } else {
            this.status.textContent = 'Esperando rostro…';
          }

          this.animationFrame = requestAnimationFrame(detect);
        };
        detect();
      }

      drawSmoothMask(landmarks) {
        const important = [
          ...landmarks.getJawOutline(),
          ...landmarks.getLeftEye(),
          ...landmarks.getRightEye(),
          ...landmarks.getNose(),
          ...landmarks.getMouth()
        ];

        // Dibujar contorno suave
        this.ctx.lineWidth = 2;
        this.ctx.strokeStyle = "rgba(0, 255, 100, 0.7)";
        this.ctx.beginPath();
        important.forEach((pt, i) => {
          if (i === 0) this.ctx.moveTo(pt.x, pt.y);
          else this.ctx.lineTo(pt.x, pt.y);
        });
        this.ctx.closePath();
        this.ctx.stroke();

        // Dibujar puntos
        this.ctx.fillStyle = "rgba(0, 255, 150, 0.9)";
        important.forEach(pt => {
          this.ctx.beginPath();
          this.ctx.arc(pt.x, pt.y, 2.5, 0, Math.PI * 2);
          this.ctx.fill();
        });
      }
    }

    window.addEventListener('DOMContentLoaded', () => new DeteccionFacial());
  </script>
</body>
</html>
