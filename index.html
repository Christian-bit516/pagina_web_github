<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mascarilla Facial con Red Neuronal (face-api.js)</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #111827; color: #e5e7eb; }
    header { padding: 1rem; background: #1f2937; color: #fff; text-align: center; }
    .stage { position: relative; width: min(100%, 800px); margin: 1rem auto; aspect-ratio: 4 / 3; background: #000; }
    video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
    .controls { display: flex; justify-content: center; gap: 1rem; margin: 1rem; }
    .btn { padding: .5rem 1rem; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .btn.start { background: #2563eb; color: #fff; }
    .btn.stop { background: #6b7280; color: #fff; }
    #status { margin-left: 1rem; font-weight: 600; }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <header>
    <h1>Mascarilla Facial con Red Neuronal</h1>
    <span id="status">Cargando modelos…</span>
  </header>

  <main>
    <div class="stage">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="controls">
      <button id="startBtn" class="btn start">Iniciar cámara</button>
      <button id="stopBtn" class="btn stop" disabled>Detener</button>
    </div>
  </main>

  <script>
    class MascarillaFacial {
      constructor() {
        this.video = document.getElementById('video');
        this.overlay = document.getElementById('overlay');
        this.ctx = this.overlay.getContext('2d');
        this.status = document.getElementById('status');
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.isActive = false;
        this.animationFrame = null;
        this.models = 'https://justadudewhohacks.github.io/face-api.js/models';
        this.initialize();
        this.bindEvents();
      }

      async initialize() {
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(this.models),
          faceapi.nets.faceLandmark68Net.loadFromUri(this.models)
        ]);
        this.status.textContent = 'Modelos cargados';
      }

      async startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
          this.video.srcObject = stream;
          await this.video.play();
          this.resizeOverlayToVideo();
          this.isActive = true;
          this.startBtn.disabled = true;
          this.stopBtn.disabled = false;
          this.status.textContent = 'Cámara activa';
          this.detectFaces();
        } catch (err) {
          this.status.textContent = 'Error accediendo a la cámara';
        }
      }

      stopCamera() {
        this.isActive = false;
        if (this.animationFrame) cancelAnimationFrame(this.animationFrame);
        if (this.video.srcObject) {
          this.video.srcObject.getTracks().forEach(track => track.stop());
          this.video.srcObject = null;
        }
        this.ctx.clearRect(0, 0, this.overlay.width, this.overlay.height);
        this.startBtn.disabled = false;
        this.stopBtn.disabled = true;
        this.status.textContent = 'Cámara detenida';
      }

      resizeOverlayToVideo() {
        this.overlay.width = this.video.videoWidth;
        this.overlay.height = this.video.videoHeight;
      }

      async detectFaces() {
        const detect = async () => {
          if (!this.isActive) return;
          const detections = await faceapi
            .detectAllFaces(this.video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks();

          this.ctx.clearRect(0, 0, this.overlay.width, this.overlay.height);

          if (detections.length > 0) {
            const landmarks = detections[0].landmarks;

            // puntos clave
            const jaw = landmarks.getJawOutline();
            const nose = landmarks.getNose();
            const leftCheek = landmarks.positions[2];
            const rightCheek = landmarks.positions[14];

            // dibujar mascarilla
            this.ctx.fillStyle = 'rgba(0, 150, 255, 0.4)'; // azul translúcido
            this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)'; // borde blanco
            this.ctx.lineWidth = 2;

            this.ctx.beginPath();
            this.ctx.moveTo(leftCheek.x, leftCheek.y);
            jaw.forEach(p => this.ctx.lineTo(p.x, p.y));
            this.ctx.lineTo(rightCheek.x, rightCheek.y);
            this.ctx.lineTo(nose[0].x, nose[0].y);
            this.ctx.lineTo(nose[3].x, nose[3].y);
            this.ctx.closePath();

            this.ctx.fill();
            this.ctx.stroke();

            // dibujar tiras de la mascarilla (opcional)
            this.ctx.strokeStyle = 'rgba(200,200,200,0.8)';
            this.ctx.lineWidth = 1.5;
            this.ctx.beginPath();
            this.ctx.moveTo(leftCheek.x, leftCheek.y);
            this.ctx.lineTo(leftCheek.x - 40, leftCheek.y - 20);
            this.ctx.moveTo(rightCheek.x, rightCheek.y);
            this.ctx.lineTo(rightCheek.x + 40, rightCheek.y - 20);
            this.ctx.stroke();

            this.status.textContent = 'Rostro detectado con mascarilla';
          } else {
            this.status.textContent = 'Esperando rostro…';
          }

          if (this.isActive) this.animationFrame = requestAnimationFrame(detect);
        };
        detect();
      }

      bindEvents() {
        this.startBtn.addEventListener('click', () => this.startCamera());
        this.stopBtn.addEventListener('click', () => this.stopCamera());
      }
    }

    window.addEventListener('DOMContentLoaded', () => new MascarillaFacial());
  </script>
</body>
</html>
