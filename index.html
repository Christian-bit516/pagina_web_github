<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Face Mesh Futurista</title>
  <style>
    body {
      margin: 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    .stage {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #000;
    }
    video, canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* espejo */
    }
    #status {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #0f0;
      padding: .6rem 1.2rem;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 0 0 10px #0f0;
      z-index: 5;
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <div class="stage">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="status">Cargando modelos…</div>
  </div>

  <script>
    class FaceMeshFuturista {
      constructor() {
        this.video = document.getElementById("video");
        this.overlay = document.getElementById("overlay");
        this.ctx = this.overlay.getContext("2d");
        this.status = document.getElementById("status");
        this.models = "https://justadudewhohacks.github.io/face-api.js/models";
        this.isActive = false;
        this.initialize();
      }

      async initialize() {
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(this.models),
          faceapi.nets.faceLandmark68Net.loadFromUri(this.models)
        ]);
        this.status.textContent = "Modelos cargados";
        this.startCamera();
      }

      async startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: "user" }, // cámara frontal
              width: { ideal: 640 },
              height: { ideal: 480 }
            },
            audio: false
          });
          this.video.srcObject = stream;
          await this.video.play();

          // ajustar canvas al tamaño real
          this.overlay.width = this.video.videoWidth;
          this.overlay.height = this.video.videoHeight;

          this.isActive = true;
          this.detectFaces();
          this.status.textContent = "Cámara activa";
        } catch (err) {
          this.status.textContent = "Error cámara: " + err.message;
        }
      }

      async detectFaces() {
        const loop = async () => {
          if (!this.isActive) return;

          const detections = await faceapi
            .detectAllFaces(this.video, new faceapi.TinyFaceDetectorOptions({
              inputSize: 160, // más rápido en móvil
              scoreThreshold: 0.5
            }))
            .withFaceLandmarks();

          this.ctx.clearRect(0, 0, this.overlay.width, this.overlay.height);

          if (detections.length > 0) {
            const landmarks = detections[0].landmarks;
            this.drawMesh(landmarks);
            this.status.textContent = "Rostro detectado";
          } else {
            this.status.textContent = "Esperando rostro…";
          }

          requestAnimationFrame(loop);
        };
        loop();
      }

      drawMesh(landmarks) {
        const points = landmarks.positions;

        // Estilo neón
        this.ctx.strokeStyle = "rgba(0,255,180,0.7)";
        this.ctx.lineWidth = 1.2;
        this.ctx.shadowBlur = 8;
        this.ctx.shadowColor = "rgba(0,255,180,0.9)";

        // Conexiones simples
        for (let i = 0; i < points.length - 1; i++) {
          const p1 = points[i], p2 = points[i + 1];
          this.ctx.beginPath();
          this.ctx.moveTo(p1.x, p1.y);
          this.ctx.lineTo(p2.x, p2.y);
          this.ctx.stroke();
        }

        // Puntos brillantes
        this.ctx.fillStyle = "rgba(0,255,180,0.95)";
        points.forEach(pt => {
          this.ctx.beginPath();
          this.ctx.arc(pt.x, pt.y, 2, 0, Math.PI * 2);
          this.ctx.fill();
        });
      }
    }

    window.addEventListener("DOMContentLoaded", () => new FaceMeshFuturista());
  </script>
</body>
</html>
