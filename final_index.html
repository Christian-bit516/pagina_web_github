<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reconocimiento Facial - Registro de Horas</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- TensorFlow.js y Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- Cuadro de la cámara a la izquierda -->
        <div class="camera-box glass-effect">
            <div class="camera-header">
                <h2>Cámara de Reconocimiento</h2>
                <p>Mire directamente a la cámara para registrar su ingreso</p>
            </div>

            <div id="webcam-container">
                <div class="scanner-line"></div>
                <video id="webcam" autoplay playsinline></video>
            </div>
        </div>

        <!-- Panel de información a la derecha -->
        <div class="info-panel glass-effect">
            <!-- Sección de información del usuario -->
            <div class="user-info-section">
                <div class="welcome-title">Bienvenido/a</div>
                <div class="user-name" id="user-display-name">Cargando...</div>
                <div class="time-info" id="current-time">Hora actual: --:--:--</div>
            </div>

            <div class="status-section">
                <div class="status-text" id="status">Inicializando sistema de reconocimiento...</div>
            </div>

            <!-- Sección de registros de horas -->
            <div class="records-section">
                <div class="records-header">Registro de Horarios</div>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora de Ingreso</th>
                            <th>Hora de Salida</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body">
                        <!-- Los registros se insertarán aquí -->
                    </tbody>
                </table>
            </div>

            <div class="countdown-section">
                <div class="countdown-text">¡Usuario reconocido! Registrando ingreso...</div>
                <div class="countdown-number" id="countdown-number">3</div>
            </div>

            <div class="button-group">
                <button id="dashboard-button" class="dashboard-button">Ir al Dashboard</button>
                <button id="logout-button" class="logout-button">Salir del Sistema</button>
                <button id="login-button" class="login-button">Volver a Ingresar</button>
            </div>
        </div>

        <div class="security-badge">
            Sistema de registro automático - Reconocimiento facial por IA
        </div>
    </div>

    <script>
        const URL = "./model/";
        const MAX_REGISTROS = 6; // Solo 6 registros como solicitado
        let model, webcam, maxPredictions;
        let recognitionCount = 0;
        let countdownInterval;
        let isCountingDown = false;
        let registros = [];
        let lastRecognitionTime = 0;
        const RECOGNITION_COOLDOWN = 30000; // 30 segundos entre registros
        let usuarioEnSistema = false;

        // Función para obtener y mostrar información del usuario
        function loadUserInfo() {
            const userName = localStorage.getItem('usuarioNombre') || 'Usuario';
            document.getElementById('user-display-name').textContent = userName;

            // Cargar registros existentes
            const savedRegistros = localStorage.getItem('registrosHorarios');
            if (savedRegistros) {
                registros = JSON.parse(savedRegistros);
                updateRecordsTable();
            }

            // Verificar estado del sistema
            const sistemaEstado = localStorage.getItem('sistemaEstado');
            if (sistemaEstado === 'ingresado') {
                usuarioEnSistema = true;
                showDashboardButton();
                showLogoutButton();
                updateStatus('✅ Sistema activo - Usuario ingresado');
            } else {
                showLoginButton();
                updateStatus('Sistema listo para reconocimiento facial');
            }

            return userName;
        }

        // Función para actualizar la hora actual
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = `Hora actual: ${now.toLocaleTimeString()}`;
        }

        // Función para agregar registro de ingreso
        function addEntryRecord() {
            const now = new Date();
            const fecha = now.toLocaleDateString();
            const horaEntrada = now.toLocaleTimeString();

            // Agregar a array de registros
            registros.unshift({
                fecha: fecha,
                entrada: horaEntrada,
                salida: "PENDIENTE",
                estado: "activo"
            });

            // Limitar a últimos 6 registros
            if (registros.length > MAX_REGISTROS) {
                registros = registros.slice(0, MAX_REGISTROS);
            }

            // Guardar en localStorage
            localStorage.setItem('registrosHorarios', JSON.stringify(registros));

            // Actualizar tabla
            updateRecordsTable();

            return now;
        }

        // Función para registrar salida
        function addExitRecord() {
            const now = new Date();
            const horaSalida = now.toLocaleTimeString();

            // Buscar el último registro activo y marcarlo como finalizado
            for (let i = 0; i < registros.length; i++) {
                if (registros[i].estado === "activo" && registros[i].salida === "PENDIENTE") {
                    registros[i].salida = horaSalida;
                    registros[i].estado = "finalizado";
                    break;
                }
            }

            // Guardar en localStorage
            localStorage.setItem('registrosHorarios', JSON.stringify(registros));

            // Actualizar tabla
            updateRecordsTable();

            return now;
        }

        // Función para actualizar la tabla de registros
        function updateRecordsTable() {
            const tableBody = document.getElementById('records-table-body');
            tableBody.innerHTML = '';

            registros.forEach((registro, index) => {
                const row = document.createElement('tr');

                if (registro.estado === "activo") {
                    row.style.backgroundColor = '#e8f5e8';
                }

                row.innerHTML = `
                    <td>${registro.fecha}</td>
                    <td>${registro.entrada}</td>
                    <td class="${registro.salida === 'PENDIENTE' ? 'pending' : ''}">${registro.salida}</td>
                    <td>${registro.estado === 'activo' ? 'Activo' : 'Finalizado'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Función para mostrar botón de dashboard (solo cuando se está en el sistema)
        function showDashboardButton() {
            if (usuarioEnSistema) {
                document.getElementById('dashboard-button').style.display = 'block';
            }
        }

        // Función para mostrar botón de salir
        function showLogoutButton() {
            document.getElementById('logout-button').style.display = 'block';
            document.getElementById('login-button').style.display = 'none';
        }

        // Función para mostrar botón de ingresar
        function showLoginButton() {
            document.getElementById('login-button').style.display = 'block';
            document.getElementById('logout-button').style.display = 'none';
            document.getElementById('dashboard-button').style.display = 'none';
        }

        // Función para ocultar todos los botones
        function hideAllButtons() {
            document.getElementById('dashboard-button').style.display = 'none';
            document.getElementById('logout-button').style.display = 'none';
            document.getElementById('login-button').style.display = 'none';
        }

        // Función para actualizar estado
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            // Cargar información del usuario
            const userName = loadUserInfo();

            // Actualizar hora cada segundo
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // Configurar event listeners para los botones
            document.getElementById('dashboard-button').addEventListener('click', function() {
                window.location.href = "dashboard.html";
            });

            document.getElementById('logout-button').addEventListener('click', function() {
                salirDelSistema();
            });

            document.getElementById('login-button').addEventListener('click', function() {
                // Este botón solo es visible cuando no se está en el sistema
                // No hace nada porque el reconocimiento ya está activo
                updateStatus('Sistema listo para reconocimiento facial');
            });

            try {
                // Cargar modelo y metadatos
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                // Configurar la cámara
                const flip = true;
                webcam = new tmImage.Webcam(500, 400, flip);
                await webcam.setup();
                await webcam.play();

                // Añadir la cámara al contenedor
                document.getElementById("webcam-container").appendChild(webcam.canvas);

                if (!usuarioEnSistema) {
                    updateStatus(`Sistema listo. Analizando rostro...`);
                }

                // Comenzar el loop de predicciones
                setTimeout(loop, 1000);

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error al cargar el modelo. Verifica la carpeta "model/"');
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            setTimeout(loop, 1000);
        }

        async function predict() {
            // Solo procesar reconocimiento si no se está en el sistema
            if (usuarioEnSistema) {
                return;
            }

            const prediction = await model.predict(webcam.canvas);
            let userDetected = false;
            const currentTime = Date.now();

            // Verificar cooldown para evitar múltiples registros seguidos
            if (currentTime - lastRecognitionTime < RECOGNITION_COOLDOWN) {
                return;
            }

            for (let i = 0; i < maxPredictions; i++) {
                const confidence = prediction[i].probability;

                // Detectar usuario con alta confianza
                if ((prediction[i].className === "Class 1" || i === 0) && confidence > 0.98) {
                    userDetected = true;
                    recognitionCount++;

                    if (recognitionCount >= 2 && !isCountingDown) {
                        lastRecognitionTime = currentTime;
                        startCountdown();
                        break;
                    }
                }
            }

            // Reiniciar contador si no se detecta
            if (!userDetected) {
                recognitionCount = 0;
            }
        }

        function startCountdown() {
            isCountingDown = true;
            const countdownSection = document.getElementById('countdown-section');
            countdownSection.style.display = 'block';

            let count = 3;
            document.getElementById('countdown-number').textContent = count;

            countdownInterval = setInterval(() => {
                count--;
                document.getElementById('countdown-number').textContent = count;

                if (count <= 0) {
                    clearInterval(countdownInterval);
                    isCountingDown = false;

                    // Registrar el ingreso
                    addEntryRecord();

                    // Cambiar estado del sistema
                    usuarioEnSistema = true;
                    localStorage.setItem('sistemaEstado', 'ingresado');

                    // Mostrar botones correspondientes
                    showDashboardButton();
                    showLogoutButton();

                    // Ocultar countdown
                    countdownSection.style.display = 'none';

                    updateStatus('Ingreso registrado correctamente');

                    // Resetear contador de reconocimiento
                    recognitionCount = 0;
                }
            }, 1000);
        }

        function salirDelSistema() {
            // Registrar salida
            addExitRecord();

            // Cambiar estado del sistema
            usuarioEnSistema = false;
            localStorage.setItem('sistemaEstado', 'salido');

            // Mostrar botón de ingresar
            showLoginButton();

            updateStatus('Salida registrada. Sistema listo para nuevo ingreso');
        }

        // Función para manejar cierre de ventana/navegador (para registrar salida)
        window.addEventListener('beforeunload', function() {
            if (usuarioEnSistema) {
                // Buscar registros activos y marcarlos como finalizados
                const now = new Date();
                registros.forEach(registro => {
                    if (registro.estado === "activo" && registro.salida === "PENDIENTE") {
                        registro.salida = now.toLocaleTimeString();
                        registro.estado = "finalizado";
                    }
                });
                localStorage.setItem('registrosHorarios', JSON.stringify(registros));
                localStorage.setItem('sistemaEstado', 'salido');
            }
        });

        // Inicializar cuando se cargue la página
        window.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>
